<!doctype html>
<html lang="ko">
<meta charset="utf-8" />
<title>Workspace API Tester (Debug)</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:24px; background:#0b0c10; color:#e6edf3; }
  .box { border:1px solid #2d333b; border-radius:12px; padding:16px; margin:12px 0; background:#161b22; }
  input, button { padding:8px; border-radius:8px; border:1px solid #2d333b; background:#0d1117; color:#e6edf3; }
  button { background:#1f6feb; cursor:pointer; }
  pre { white-space:pre-wrap; background:#0d1117; border:1px solid #2d333b; padding:12px; border-radius:8px; }
</style>

<body>
  <h1>Workspace API Tester (Debug)</h1>

  <div class="box">
    <label>API Base URL
      <input id="baseUrl" type="text" value="http://localhost:8000">
    </label>
    <label style="margin-left:8px;">Base Path (prefix)
      <input id="basePath" type="text" value=""> <!-- 예: /api -->
    </label>
    <button id="ping">Check /workspaces</button>
  </div>

  <div class="box">
    <h2>Create (POST /workspaces)</h2>
    <input id="create-name" placeholder="entocr-2025">
    <input id="create-start" type="date">
    <input id="create-end" type="date">
    <button id="create-btn">Create</button>
  </div>

  <div class="box">
    <h2>List (GET /workspaces)</h2>
    <button id="list-btn">List</button>
  </div>

  <div class="box">
    <h2>Update Period (PATCH /workspaces/{name}/period)</h2>
    <input id="update-name" placeholder="entocr-2025">
    <input id="update-start" type="date">
    <input id="update-end" type="date">
    <button id="update-btn">Update</button>
  </div>

  <div class="box">
    <h2>Rename (PATCH /workspaces/{oldName})</h2>
    <input id="rename-old" placeholder="entocr-2025">
    <input id="rename-new" placeholder="entocr-q1">
    <input id="rename-archived" placeholder="false (optional)">
    <button id="rename-btn">Rename</button>
  </div>

  <div class="box">
    <h2>Delete (DELETE /workspaces/{workspaceName})</h2>
    <input id="delete-name" placeholder="entocr-q1">
    <button id="delete-btn">Delete</button>
  </div>

  <div class="box">
    <h2>Response / Logs</h2>
    <pre id="out">Logs will appear here.</pre>
  </div>

  <div class="box">
    <h2>Upload Images (POST /workspaces/{name}/uploads/images)</h2>
    <div>
      <input id="upimg-name" placeholder="entocr-2025" />
    </div>
    <div style="margin-top:8px">
      <input id="upimg-files" type="file" multiple />
    </div>
    <div class="small" style="margin-top:6px">
      allowedExt (예: .png,.jpg) / renameOnConflict / ifMatchIndexVersion
    </div>
    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:6px">
      <input id="upimg-allowed" placeholder=".png,.jpg,.jpeg" />
      <label style="display:flex; align-items:center; gap:6px">
        <input id="upimg-rename" type="checkbox" checked /> renameOnConflict
      </label>
      <input id="upimg-ifmatch" type="number" placeholder="ifMatchIndexVersion (optional)" />
      <button id="upimg-btn">Upload Images</button>
    </div>
  </div>
  
  <div class="box">
    <h2>Upload ZIP (POST /workspaces/{name}/uploads/zip)</h2>
    <div>
      <input id="upzip-name" placeholder="entocr-2025" />
    </div>
    <div style="margin-top:8px">
      <input id="upzip-file" type="file" accept=".zip" />
    </div>
    <div class="small" style="margin-top:6px">
      allowedExt (예: .png,.jpg) / preserveDirs / renameOnConflict / rollbackOnFailure / ifMatchIndexVersion
    </div>
    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:6px">
      <input id="upzip-allowed" placeholder=".png,.jpg,.jpeg" />
      <label style="display:flex; align-items:center; gap:6px">
        <input id="upzip-preserve" type="checkbox" checked /> preserveDirs
      </label>
      <label style="display:flex; align-items:center; gap:6px">
        <input id="upzip-rename" type="checkbox" checked /> renameOnConflict
      </label>
      <label style="display:flex; align-items:center; gap:6px">
        <input id="upzip-rollback" type="checkbox" checked /> rollbackOnFailure
      </label>
      <input id="upzip-ifmatch" type="number" placeholder="ifMatchIndexVersion (optional)" />
      <button id="upzip-btn">Upload ZIP</button>
    </div>
  </div>
  
  <div class="box">
    <h2>Get Uploaded Files (GET /workspaces/{name}/uploads)</h2>
    <div style="display:flex; gap:8px; flex-wrap:wrap">
      <input id="upls-name" placeholder="entocr-2025" />
      <button id="upls-btn">List Uploaded</button>
    </div>
  </div>
  
  <div class="box">
    <h2>Exclude/Include Files (PATCH /workspaces/{name}/uploads/excluded)</h2>
    <div class="small">filePaths는 쉼표로 구분, excluded=true/false</div>
    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:6px">
      <input id="ex-name" placeholder="entocr-2025" />
      <input id="ex-files" placeholder="a.png,b.png" />
      <select id="ex-excluded">
        <option value="true">true</option>
        <option value="false">false</option>
      </select>
      <button id="ex-btn">Apply</button>
    </div>
  </div>
  
  <div class="box">
    <h2>Set Project Mapping (PATCH /workspaces/{name}/uploads/projects)</h2>
    <div class="small">JSON: {"a.png":"projA","b.png":null}</div>
    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:6px">
      <input id="pm-name" placeholder="entocr-2025" />
      <input id="pm-json" style="min-width:420px" placeholder='{"a.png":"projA","b.png":null}' />
      <button id="pm-btn">Apply</button>
    </div>
  </div>
  

<script>
(function(){
  const $ = (id) => document.getElementById(id);
  const out = $("out");
  const j = (v) => JSON.stringify(v, null, 2);

  // 전역 에러 캡처 → 화면에 표시
  window.addEventListener("error", (e) => {
    log(`# window.error\n` + (e?.error?.stack || e.message || e));
  });
  window.addEventListener("unhandledrejection", (e) => {
    log(`# unhandledrejection\n` + (e?.reason?.stack || e.reason || e));
  });

  function log(msg) {
    console.log(msg);
    out.textContent = (out.textContent + "\n" + msg).trim();
  }

  function apiPath(p) {
    const base = $("baseUrl").value.replace(/\/+$/, "");
    const prefix = $("basePath").value.replace(/\/+$/, "");
    const path = (prefix ? prefix : "") + p;
    return `${base}${path}`;
  }

  async function api(p, { method="GET", body } = {}) {
    const url = apiPath(p);
    const opts = { method, headers: { "Content-Type": "application/json" } };
    if (body) opts.body = JSON.stringify(body);
    log(`→ ${method} ${url}\n${body ? j(body) : ""}`);
    const res = await fetch(url, opts);
    const text = await res.text();
    let payload;
    try { payload = JSON.parse(text); } catch { payload = text; }
    log(`← status=${res.status}, ok=${res.ok}\n${j(payload)}`);
    return { status: res.status, ok: res.ok, json: payload };
  }

  document.addEventListener("DOMContentLoaded", () => {
    // 기본값 seed
    const today = new Date();
    const yyyy = today.getFullYear();
    $("create-name").value = "entocr-2025";
    $("update-name").value = "entocr-2025";
    $("rename-old").value = "entocr-2025";
    $("rename-new").value = "entocr-q1";
    $("delete-name").value = "entocr-q1";
    $("create-start").value = `${yyyy}-01-01`;
    $("create-end").value = `${yyyy}-03-31`;
    $("update-start").value = `${yyyy}-01-01`;
    $("update-end").value = `${yyyy}-03-31`;

    $("ping").addEventListener("click", async () => {
      try { await api("/workspaces"); } catch (e) { log(e?.stack || e); }
    });

    $("create-btn").addEventListener("click", async () => {
      try {
        await api("/workspaces", {
          method: "POST",
          body: {
            workspaceName: $("create-name").value.trim(),
            periodStart: $("create-start").value,
            periodEnd: $("create-end").value,
          },
        });
      } catch (e) { log(e?.stack || e); }
    });

    $("list-btn").addEventListener("click", async () => {
      try { await api("/workspaces"); } catch (e) { log(e?.stack || e); }
    });

    $("update-btn").addEventListener("click", async () => {
      try {
        await api(`/workspaces/${encodeURIComponent($("update-name").value.trim())}/period`, {
          method: "PATCH",
          body: {
            periodStart: $("update-start").value,
            periodEnd: $("update-end").value,
          },
        });
      } catch (e) { log(e?.stack || e); }
    });

    $("rename-btn").addEventListener("click", async () => {
      try {
        const includeArchivedRaw = $("rename-archived").value.trim();
        const includeArchived = includeArchivedRaw === "" ? undefined : /^true$/i.test(includeArchivedRaw);
        const body = { newName: $("rename-new").value.trim() };
        if (includeArchived !== undefined) body.includeArchived = includeArchived;
        await api(`/workspaces/${encodeURIComponent($("rename-old").value.trim())}`, {
          method: "PATCH",
          body,
        });
      } catch (e) { log(e?.stack || e); }
    });

    $("delete-btn").addEventListener("click", async () => {
      try {
        await api(`/workspaces/${encodeURIComponent($("delete-name").value.trim())}`, { method: "DELETE" });
      } catch (e) { log(e?.stack || e); }
    });
  });
})();

document.addEventListener("DOMContentLoaded", () => {
  const $ = (id) => document.getElementById(id);
  const j = (v) => JSON.stringify(v, null, 2);
  const out = document.getElementById("out");
  const log = (m)=>{ console.log(m); out.textContent = (out.textContent + "\n" + m).trim(); };

  function apiPath(p) {
    const base = document.getElementById("baseUrl").value.replace(/\/+$/, "");
    const prefix = document.getElementById("basePath").value.replace(/\/+$/, "");
    const path = (prefix ? prefix : "") + p;
    return `${base}${path}`;
  }

  async function apiForm(p, formData, method="POST") {
    const url = apiPath(p);
    log(`→ ${method} ${url} (FormData)`);
    const res = await fetch(url, { method, body: formData });
    const text = await res.text();
    let payload; try { payload = JSON.parse(text); } catch { payload = text; }
    log(`← status=${res.status}, ok=${res.ok}\n${j(payload)}`);
    return { status: res.status, ok: res.ok, json: payload };
  }
  async function apiJson(p, method, bodyObj) {
    const url = apiPath(p);
    log(`→ ${method} ${url}\n${j(bodyObj)}`);
    const res = await fetch(url, { method, headers: { "Content-Type": "application/json" }, body: JSON.stringify(bodyObj) });
    const text = await res.text();
    let payload; try { payload = JSON.parse(text); } catch { payload = text; }
    log(`← status=${res.status}, ok=${res.ok}\n${j(payload)}`);
    return { status: res.status, ok: res.ok, json: payload };
  }

  // Upload Images
  $("upimg-btn").addEventListener("click", async () => {
    const ws = $("upimg-name").value.trim();
    const files = $("upimg-files").files;
    if (!ws || !files?.length) { log("workspaceName/files required"); return; }
    const fd = new FormData();
    for (const f of files) fd.append("files", f, f.name);
    const allowed = $("upimg-allowed").value.trim();
    if (allowed) fd.append("allowedExt", allowed);
    fd.append("renameOnConflict", $("upimg-rename").checked ? "true" : "false");
    const ifmatch = $("upimg-ifmatch").value.trim();
    if (ifmatch) fd.append("ifMatchIndexVersion", ifmatch);
    await apiForm(`/workspaces/${encodeURIComponent(ws)}/uploads/images`, fd, "POST");
  });

  // Upload ZIP
  $("upzip-btn").addEventListener("click", async () => {
    const ws = $("upzip-name").value.trim();
    const f = $("upzip-file").files?.[0];
    if (!ws || !f) { log("workspaceName/zip required"); return; }
    const fd = new FormData();
    fd.append("file", f, f.name);
    const allowed = $("upzip-allowed").value.trim();
    if (allowed) fd.append("allowedExt", allowed);
    fd.append("preserveDirs", $("upzip-preserve").checked ? "true" : "false");
    fd.append("renameOnConflict", $("upzip-rename").checked ? "true" : "false");
    fd.append("rollbackOnFailure", $("upzip-rollback").checked ? "true" : "false");
    const ifmatch = $("upzip-ifmatch").value.trim();
    if (ifmatch) fd.append("ifMatchIndexVersion", ifmatch);
    await apiForm(`/workspaces/${encodeURIComponent(ws)}/uploads/zip`, fd, "POST");
  });

  // List Uploaded
  $("upls-btn").addEventListener("click", async () => {
    const ws = $("upls-name").value.trim();
    if (!ws) { log("workspaceName required"); return; }
    await fetch(apiPath(`/workspaces/${encodeURIComponent(ws)}/uploads`))
      .then(r=>r.text())
      .then(t=>{
        let payload; try { payload = JSON.parse(t); } catch { payload = t; }
        log(`← GET uploads\n${j(payload)}`);
      })
      .catch(e=>log(e?.stack||e));
  });

  // Exclude/Include
  $("ex-btn").addEventListener("click", async () => {
    const ws = $("ex-name").value.trim();
    if (!ws) { log("workspaceName required"); return; }
    const list = $("ex-files").value.split(",").map(s=>s.trim()).filter(Boolean);
    const excluded = $("ex-excluded").value === "true";
    await apiJson(`/workspaces/${encodeURIComponent(ws)}/uploads/excluded`, "PATCH", { filePaths: list, excluded });
  });

  // Project Mapping
  $("pm-btn").addEventListener("click", async () => {
    const ws = $("pm-name").value.trim();
    if (!ws) { log("workspaceName required"); return; }
    let map;
    try { map = JSON.parse($("pm-json").value); }
    catch { log("mapping must be JSON"); return; }
    await apiJson(`/workspaces/${encodeURIComponent(ws)}/uploads/projects`, "PATCH", { mapping: map });
  });
});
</script>
</body>
</html>
