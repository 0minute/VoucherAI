<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API ì„¤ì •</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .config-form {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        button {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .success {
            color: green;
            margin-top: 20px;
        }
        .error {
            color: red;
            margin-top: 20px;
        }
        .current {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="config-form">
        <h1>ğŸ”§ API ì„¤ì •</h1>
        
        <div class="current">
            <h3>í˜„ì¬ ì„¤ì •:</h3>
            <p><strong>BASE_URL:</strong> <span id="current-base-url">-</span></p>
            <p><strong>TOKEN:</strong> <span id="current-token">-</span></p>
        </div>

        <div class="form-group">
            <label for="baseUrlInput">Base URL:</label>
            <input type="text" id="baseUrlInput" placeholder="http://localhost:8000" value="http://localhost:8000">
        </div>

        <div class="form-group">
            <label for="tokenInput">Token (ì„ íƒì‚¬í•­):</label>
            <input type="text" id="tokenInput" placeholder="Bearer token (ë¹„ì›Œë‘˜ ìˆ˜ ìˆìŒ)">
        </div>

        <button id="saveBtn">ì„¤ì • ì €ì¥</button>
        <button id="pingBtn" style="background: #28a745;">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
        <button onclick="clearConfig()" style="background: #dc3545;">ì„¤ì • ì´ˆê¸°í™”</button>

        <hr style="margin: 30px 0;">
        
        <h3>ğŸ”§ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì´ë¦„ ë³€ê²½ í…ŒìŠ¤íŠ¸</h3>
        <div class="form-group">
            <label for="oldNameInput">ê¸°ì¡´ ì´ë¦„:</label>
            <input type="text" id="oldNameInput" placeholder="ì˜ˆ: STELLAR ê´‘ê³ ì´¬ì˜ ì •ì‚°">
        </div>
        <div class="form-group">
            <label for="newNameInput">ìƒˆ ì´ë¦„:</label>
            <input type="text" id="newNameInput" placeholder="ì˜ˆ: STELLAR ê´‘ê³ ì´¬ì˜ ì •ì‚° ìˆ˜ì •ë¨">
        </div>
        <button id="testRenameBtn" style="background: #ffc107; color: black;">ì´ë¦„ ë³€ê²½ í…ŒìŠ¤íŠ¸</button>

        <div id="result"></div>
    </div>

    <script type="module">
        import { getBaseUrl, setBaseUrl, getToken, setToken } from './front/common/config.js';
        import apiClient from './front/common/apiClient.js';

        // í˜„ì¬ ì„¤ì • í‘œì‹œ
        function loadCurrentConfig() {
            document.getElementById('current-base-url').textContent = getBaseUrl() || 'ì„¤ì •ë˜ì§€ ì•ŠìŒ';
            document.getElementById('current-token').textContent = getToken() ? 'ì„¤ì •ë¨' : 'ì„¤ì •ë˜ì§€ ì•ŠìŒ';
            
            // ì…ë ¥ í•„ë“œì—ë„ í˜„ì¬ ê°’ ì„¤ì •
            document.getElementById('baseUrlInput').value = getBaseUrl();
            document.getElementById('tokenInput').value = getToken();
        }

        // ì„¤ì • ì €ì¥
        window.saveConfig = function() {
            const baseUrl = document.getElementById('baseUrlInput').value.trim();
            const token = document.getElementById('tokenInput').value.trim();

            setBaseUrl(baseUrl);
            setToken(token);

            document.getElementById('result').innerHTML = '<div class="success">âœ… ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</div>';
            loadCurrentConfig();
        };

        // ì—°ê²° í…ŒìŠ¤íŠ¸ - /workspaces ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©
        window.testConnection = async function() {
            const baseUrl = getBaseUrl();
            if (!baseUrl) {
                document.getElementById('result').innerHTML = '<div class="error">âŒ BASE_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            const pingBtn = document.getElementById('pingBtn');
            pingBtn.disabled = true;
            pingBtn.textContent = 'ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...';

            try {
                console.log('ğŸ”„ API ì—°ê²° í…ŒìŠ¤íŠ¸:', baseUrl);
                const response = await apiClient.get('/workspaces');
                
                console.log('âœ… API ì‘ë‹µ:', response);
                document.getElementById('result').innerHTML = `<div class="success">âœ… ì—°ê²° ì„±ê³µ! ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ${response.workspaces?.length || 0}ê°œ ë°œê²¬</div>`;
                
            } catch (error) {
                console.error('âŒ API ì—°ê²° ì‹¤íŒ¨:', error);
                document.getElementById('result').innerHTML = `<div class="error">âŒ ì—°ê²° ì‹¤íŒ¨: ${error.message}</div>`;
                
            } finally {
                pingBtn.disabled = false;
                pingBtn.textContent = 'ì—°ê²° í…ŒìŠ¤íŠ¸';
            }
        };

        // ì„¤ì • ì´ˆê¸°í™”
        window.clearConfig = function() {
            localStorage.removeItem('BASE_URL');
            localStorage.removeItem('TOKEN');
            document.getElementById('baseUrlInput').value = '';
            document.getElementById('tokenInput').value = '';
            document.getElementById('result').innerHTML = '<div style="color: orange;">ğŸ”„ ì„¤ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.</div>';
            loadCurrentConfig();
        };

        // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì´ë¦„ ë³€ê²½ í…ŒìŠ¤íŠ¸
        window.testRename = async function() {
            const oldName = document.getElementById('oldNameInput').value.trim();
            const newName = document.getElementById('newNameInput').value.trim();
            
            if (!oldName || !newName) {
                document.getElementById('result').innerHTML = '<div class="error">âŒ ê¸°ì¡´ ì´ë¦„ê³¼ ìƒˆ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>';
                return;
            }
            
            if (oldName === newName) {
                document.getElementById('result').innerHTML = '<div class="error">âŒ ê¸°ì¡´ ì´ë¦„ê³¼ ìƒˆ ì´ë¦„ì´ ë™ì¼í•©ë‹ˆë‹¤.</div>';
                return;
            }

            const testBtn = document.getElementById('testRenameBtn');
            testBtn.disabled = true;
            testBtn.textContent = 'ì´ë¦„ ë³€ê²½ ì¤‘...';

            try {
                console.log('ğŸ”„ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì´ë¦„ ë³€ê²½ í…ŒìŠ¤íŠ¸:', { oldName, newName });
                
                // URL ì¸ì½”ë”© í™•ì¸
                const encodedOldName = encodeURIComponent(oldName);
                console.log('ğŸ” URL ì¸ì½”ë”©:', { original: oldName, encoded: encodedOldName });
                
                // API ìš”ì²­
                console.log('ğŸ“¤ API ìš”ì²­ ìƒì„¸:', {
                    url: `/workspaces/${encodedOldName}`,
                    method: 'PATCH',
                    body: {
                        newName: newName,
                        includeArchived: false
                    }
                });
                
                const response = await apiClient.patch(`/workspaces/${encodedOldName}`, {
                    json: {
                        newName: newName,
                        includeArchived: false
                    }
                });
                
                console.log('âœ… ì´ë¦„ ë³€ê²½ ì„±ê³µ:', response);
                document.getElementById('result').innerHTML = `<div class="success">âœ… ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì´ë¦„ì´ "${newName}"ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!</div>`;
                
                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                document.getElementById('oldNameInput').value = '';
                document.getElementById('newNameInput').value = '';
                
            } catch (error) {
                console.error('âŒ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì´ë¦„ ë³€ê²½ ì‹¤íŒ¨:', error);
                console.error('ğŸ“‹ ì—ëŸ¬ ê°ì²´ ì „ì²´:', JSON.stringify(error, null, 2));
                
                // ìƒì„¸ ì—ëŸ¬ ì •ë³´ ì¶œë ¥
                let errorDetail = error.message;
                if (error.serverError) {
                    errorDetail += `<br><strong>ì„œë²„ ì—ëŸ¬:</strong> ${error.serverError}`;
                }
                if (error.status) {
                    errorDetail += `<br><strong>HTTP ìƒíƒœ:</strong> ${error.status}`;
                }
                
                // JSONìœ¼ë¡œ ì „ì²´ ì—ëŸ¬ ì •ë³´ í‘œì‹œ
                const errorJson = JSON.stringify({
                    message: error.message,
                    status: error.status,
                    serverError: error.serverError,
                    ts: error.ts
                }, null, 2);
                
                document.getElementById('result').innerHTML = `
                    <div class="error">
                        âŒ ì´ë¦„ ë³€ê²½ ì‹¤íŒ¨: ${errorDetail}
                        <details style="margin-top: 10px;">
                            <summary>ìƒì„¸ ì—ëŸ¬ ì •ë³´ (í´ë¦­í•´ì„œ í¼ì¹˜ê¸°)</summary>
                            <pre style="background: #f5f5f5; padding: 10px; margin-top: 5px; font-size: 12px; overflow-x: auto;">${errorJson}</pre>
                        </details>
                    </div>
                `;
                
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'ì´ë¦„ ë³€ê²½ í…ŒìŠ¤íŠ¸';
            }
        };

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        document.getElementById('saveBtn').addEventListener('click', saveConfig);
        document.getElementById('pingBtn').addEventListener('click', testConnection);
        document.getElementById('testRenameBtn').addEventListener('click', testRename);

        // í˜ì´ì§€ ë¡œë“œ ì‹œ í˜„ì¬ ì„¤ì • í‘œì‹œ
        loadCurrentConfig();
    </script>
</body>
</html>
